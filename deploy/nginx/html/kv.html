<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KV GUI</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
      label { font-weight: 600; }
      input[type="text"] { padding: 8px; width: 360px; max-width: 100%; }
      textarea { width: 100%; height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; padding: 10px; }
      button { padding: 10px 14px; cursor: pointer; }
      .btns { display: flex; gap: 10px; flex-wrap: wrap; }
      pre { background: #0b0f14; color: #d6deeb; padding: 12px; overflow: auto; border-radius: 6px; }
      .hint { color: #444; }
      .err { color: #b00020; font-weight: 600; }
      .ok { color: #0a7a0a; font-weight: 600; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-top: 16px; }

      .keys {
        margin-top: 12px;
        border-top: 1px solid #eee;
        padding-top: 12px;
      }
      .key-item {
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
      }
      .key-item:hover {
        background: #f0f0f0;
      }
      .key-meta {
        color: #666;
        font-size: 12px;
        margin-left: 6px;
      }
    </style>
  </head>
  <body>
    <h1>KV GUI</h1>
    <p class="hint">Calls <code>/api/kv</code>.</p>

    <div class="card">
      <div class="row">
        <div>
          <label for="key">Key</label><br />
          <input id="key" type="text" placeholder="e.g. test" />
        </div>

        <div class="btns">
          <button id="btnGet">GET</button>
          <button id="btnPut">PUT</button>
          <button id="btnDel">DELETE</button>
          <button id="btnList">LIST KEYS</button>
        </div>
      </div>

      <div style="margin-top: 14px;">
        <label for="value">Value (JSON object)</label>
        <textarea id="value" spellcheck="false">{ "a": 1, "b": [true, "x"] }</textarea>
        <div class="hint">
          PUT sends <code>{"value": ...}</code>. Must be a JSON object.
        </div>
      </div>

      <div id="keys" class="keys"></div>
    </div>

    <div class="card">
      <div id="status" class="hint">Ready.</div>
      <pre id="out">{}</pre>
    </div>

    <script>
      const elKey = document.getElementById("key");
      const elValue = document.getElementById("value");
      const elOut = document.getElementById("out");
      const elStatus = document.getElementById("status");
      const elKeys = document.getElementById("keys");

      function setStatus(msg, kind = "hint") {
        elStatus.className = kind;
        elStatus.textContent = msg;
      }

      function pretty(obj) {
        return JSON.stringify(obj, null, 2);
      }

      function ensureKey() {
        const k = (elKey.value || "").trim();
        if (!k) {
          setStatus("Key is required.", "err");
          throw new Error("missing key");
        }
        return k;
      }

      async function readJsonResponse(res) {
        const text = await res.text();
        if (!text) return {};
        try { return JSON.parse(text); } catch { return { _raw: text }; }
      }

      async function doGet() {
        const k = ensureKey();
        setStatus(`GET /api/kv/${k} ...`);
        const res = await fetch(`/api/kv/${encodeURIComponent(k)}`);
        const data = await readJsonResponse(res);

        if (!res.ok) {
          setStatus(`GET failed (${res.status})`, "err");
          elOut.textContent = pretty(data);
          return;
        }

        setStatus("GET ok", "ok");
        elOut.textContent = pretty(data);

        if (data.value !== undefined) {
          elValue.value = pretty(data.value);
        }
      }

      async function doPut() {
        const k = ensureKey();
        let parsed;

        try {
          parsed = JSON.parse(elValue.value);
        } catch (e) {
          setStatus(`Invalid JSON: ${e.message}`, "err");
          return;
        }

        if (parsed === null || Array.isArray(parsed) || typeof parsed !== "object") {
          setStatus("Value must be a JSON object.", "err");
          return;
        }

        setStatus(`PUT /api/kv/${k} ...`);
        const res = await fetch(`/api/kv/${encodeURIComponent(k)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ value: parsed }),
        });

        if (!res.ok) {
          setStatus(`PUT failed (${res.status})`, "err");
          elOut.textContent = pretty(await readJsonResponse(res));
          return;
        }

        setStatus("PUT ok", "ok");
        elOut.textContent = pretty({ key: k, upserted: true });
        doList();
      }

      async function doDelete() {
        const k = ensureKey();
        setStatus(`DELETE /api/kv/${k} ...`);
        const res = await fetch(`/api/kv/${encodeURIComponent(k)}`, { method: "DELETE" });
        const data = await readJsonResponse(res);

        if (!res.ok) {
          setStatus(`DELETE failed (${res.status})`, "err");
          elOut.textContent = pretty(data);
          return;
        }

        setStatus("DELETE ok", "ok");
        elOut.textContent = pretty(data);
        doList();
      }

      async function doList() {
        setStatus("LIST /api/kv ...");
        elKeys.innerHTML = "";

        const res = await fetch("/api/kv");
        const data = await readJsonResponse(res);

        if (!res.ok) {
          setStatus(`LIST failed (${res.status})`, "err");
          elOut.textContent = pretty(data);
          return;
        }

        setStatus(`LIST ok (${data.count} keys)`, "ok");

        if (!data.items || data.items.length === 0) {
          elKeys.innerHTML = "<div class='hint'>No keys.</div>";
          return;
        }

        data.items.forEach(item => {
          const div = document.createElement("div");
          div.className = "key-item";
          div.textContent = item.key;

          const meta = document.createElement("span");
          meta.className = "key-meta";
          meta.textContent = item.updated_at;

          div.appendChild(meta);

          div.onclick = () => {
            elKey.value = item.key;
            doGet();
          };

          elKeys.appendChild(div);
        });
      }

      document.getElementById("btnGet").onclick = () => doGet().catch(() => {});
      document.getElementById("btnPut").onclick = () => doPut().catch(() => {});
      document.getElementById("btnDel").onclick = () => doDelete().catch(() => {});
      document.getElementById("btnList").onclick = () => doList().catch(() => {});
    </script>
  </body>
</html>
